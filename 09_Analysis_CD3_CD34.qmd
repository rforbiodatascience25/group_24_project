---
title: "CD34+ and CD3 analysis"
author: "inma"
format: html
editor: visual
---

# 1. LOAD LIBRARIES

```{r}

library(tidyverse)
library(ggplot2)

```

# 2. LOAD DATA

```{r}
data_clean <- read_tsv('data/03_dat_aug.tsv.gz')
```

# 3. ANALYSIS

## 3.1. CD34+ ANALYSIS

**Description**: The visualitzation presented is a Scatter Plot generated using ggplot2. It ilustrates the relationship between the administered CD34+ cell dose and post-transplant survival time specifically for patients with a recorded survival status of Dead.

This plot shows a very weak and highly uncertain positive correlation between the CD34+ cell dose ans survival confirmed by the hight data dispersion and the wide confidence interval of the regression line.

```{r}

data <- data_clean |>
  filter(survival_status == 'Dead')

# Plot using the fuction 
ggplot(data, 
       aes(x = CD34kgx10d6, 
           y = survival_time)) + 
  geom_point() + 
  geom_smooth(method = 'lm', se = TRUE) + 
  labs(title = 'CD34+ dose vs Survival Days',
       x = 'CD34+ cells/kg', 
       y = 'Days survived post-transplant')

```

**Description** : This plot revealed a slightly higher median CD34+ dose in the 'Alive' group compared to the 'Dead' group. While it suggest a marginal benefit od a higher dose, a formal statistical testing its required.

```{r}

  ggplot(data_clean,
         aes(x = survival_status, 
             y = CD34kgx10d6, 
             fill = survival_status)) + 
  geom_boxplot(alpha = 0.5) +
  labs(title = "CD34+ dose for each Survival Status",
       x = "Survival Status",
       y = "CD34+ cells/kg") +
  scale_fill_viridis_d()

ggsave('CD34+_dose.png', width = 6)
```

## 3.2. CD3 ANALYSIS

**Description**: This plot reveals findings analogous to the CD34+ analysis. The linear regression models exhibits a negligible positive slope, indicating a statistically weak and highly uncertain correlation where increased CD3+ dose is barely associated with longer survival. It shows a extremely wide confidence interval which demostrates high data variability and confirm that CD3+ dose is not a reliable predictor of survival time.

```{r}

data <- data_clean |> 
  filter(survival_status == 'Dead')

ggplot(data, 
       aes(x = CD3dkgx10d8, 
           y = survival_time)) +
  geom_point() + 
  geom_smooth(method = 'lm', se = TRUE) + 
  labs(title = 'CD3 dose vs survival Days',
       x = 'CD3+ cells/kg', 
       y = 'Days survived post-transplant')



```

**Description** : This boxplot compares the CD3+ cell dose between surviving and non-surviving patients. The median CD3+ dose is notably higher in Alive group. This visual evidence suggest that the CD3+ cell dose is more strongly associated with survival status that the previously analyzed CD34+ dose, positioning it as a potentially more important factor in predicting a successful outcome.

```{r}

ggplot(data_clean,
       aes(x = survival_status, 
           y = CD3dkgx10d8,
           fill = survival_status)) +
  geom_boxplot(alpha = 0.5) +
  labs(title = "CD3+ dose for each Survival Status",
       x = "Survival Status",
       y = "CD3+ cells/kg",
       fill = 'Survival Status') +
  theme_minimal() +
  scale_fill_viridis_d()
ggsave('CD3+_dose.png', width = 6)

```

## 3.3. aGvHD III/IV and cGvHD extense ANALYSIS

The development of acute (aGvHD III/IV) and extensive chronic (cGvHD) graft- versus-host diseade has been associated with the dose of CD3+ T cells administered during bone marrow transplantation. Higher CD3+ doses can enhance the graft immune response but also increase the risk of severe GvHD. Therefore, CD3+ dose is critical factor influencing early and late post-transplant immunological outcomes, higlighting the need for a careful balance between benefit and risk

In this analysis, we explore the relationship between CD3+ T cell dose, patient survival time and the development of graft-versus-host disease (GvHD) following bone marrow transplantation. Specifically, we examine how the ocurrence of severe acute GvHD (aGvHD III/IV) and extensive chronic GvHD (cGvHD) correlates with CD3+ cell dose and impacts post-transplant survival. Separate scatter plots are generated for each GvHD type to visualize potential trends and differences, providing insights into the immunological outcomes associated with varying CD3+ doses.

### 3.3.1. aGvHD III/IV (acute Graft-vs-Host Disease)

**Description**:

```{r}

data <- data_clean |>
  filter(survival_status == 'Dead')


ggplot(data, 
       aes(x = CD3dkgx10d8, 
           y = survival_time, 
           color = aGvHDIIIIV)) + 
  geom_point(size = 3, alpha = 0.7) + 
  scale_fill_viridis_d() + 

  geom_smooth(aes(group = aGvHDIIIIV), 
              method = 'lm', 
              se = FALSE) +
   scale_fill_viridis_d() +
  theme_minimal() 
```

**Description** :

```{r}

data <- data_clean |>
  filter(survival_status == 'Dead', !is.na(extcGvHD))
  


# Plot

ggplot(data,
       aes(x = CD3dkgx10d8, 
           y = survival_time,
           color = factor(extcGvHD))) + 
  geom_point(size = 3, alpha = 0.7) + 

  labs(
    x = 'Doses of CD3+', 
    y = 'Survival time (days)',
    color = 'cGvHD extense'
  ) +
  theme_minimal() +
  scale_fill_viridis_d() +
  geom_smooth(aes(group = extcGvHD), 
              method = 'lm', 
              se = FALSE)
```

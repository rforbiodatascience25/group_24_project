---
title: "CD34+ and CD3 analysis"
author: "inma"
format: html
editor: visual
---

```{r}

library(tidyverse)
library(ggplot2)
library(dplyr)
```

```{r}
data <- read_tsv('data/bone-marrow-clean.tsv.gz')
```

```{r}
# Function for grouping data based on survival status
subset_deceased <- function(data) {
  data |>
    filter(survival_status == "Dead")
}


# Function for grouping data based on survival status
group_surv <- function(data_clean) {
  data_clean |>
    group_by(survival_status)
}
```

Linear regression between Survival rate of survival population and the dose of CD34+ per Kg of recipient body weight.

```{r}

# Filter only the survival group 
group_surv <- function(data) {
  data |>
    filter(survival_status == '0')
}

# Plot using the fuction 
ggplot(group_surv(df), 
       aes(x = CD34kgx10d6, 
           y = survival_time)) + 
  geom_point() + 
  geom_smooth(method = 'lm', se = TRUE) + 
  labs(title = 'CD34+ dose vs Survival Days',
       x = 'CD34+ cells/kg', 
       y = 'Days survived post-transplant')
```

In this plot, the relationship between CD34+ cell dose and post-transplant survival was analyzed. Patients predominantly received low CD34+ doses (0-25 cells/kg), with survival times ranging from approximately 500 - 3500 days. Linear regression revealed a near-flat, slightly positive slope, indicating minimal influence of CD34+ dose on survival. The widening confidence interval at higher doses reflects increased uncertainty due to fewer data points. Overall, CD34+ dose does not appear to predict survival in this patient group, with both low and high dose recipients showing highly variable outcomes

This plot is taking into account all the patients

```{r}

ggplot(data, 
       aes(x = CD34kgx10d6, 
           y = survival_time)) + 
  geom_point() + 
  geom_smooth(method = 'lm', se = TRUE) + 
  labs(title = 'CD34+ dose vs Survival Days',
       x = 'CD34+ cells/kg', 
       y = 'Days survived post-transplant')
```

The scatter plot shows the relationship between the CD34+ cell dose per kilogram of recipient body weight and the post-transplant survival time. Each point represents an individual patient, and the blue line represents a flitted linear regression model with its 95 % confidence interval ( grey area).

A slight positive correlation was observed between CD34+ cell dose per kg and post-transplant survival time, indicating that higher doses may be associated with improved survival. However, the large variance in survival across CD34+ dose levels suggests that this factor alone is insufficient to accurately predicts patient outcomes. Additional clinical and cellular parameters are likely required to better explain survival differences.

CD3+ case (without filtering)

```{r}
ggplot(data, 
       aes(x = CD3dkgx10d8, 
           y = survival_time)) +
  geom_point() + 
  geom_smooth(method = 'lm', se = TRUE) + 
  labs(title = 'CD3 dose vs survival Days',
       x = 'CD3+ cells/kg', 
       y = 'Days survived post-transplant')
```

CD3 case ( filtering those who survived) :

```{r}
# Filter only the survival group 
group_surv <- function(data) {
  data |>
    filter(survival_status == '0')
}

# Plot for the filtered data 
ggplot(group_surv(df), 
       aes(x = CD3dkgx10d8, 
           y = survival_time)) +
  geom_point() + 
  geom_smooth(method = 'lm', se = TRUE) + 
  labs(title = 'CD3 dose vs survival Days',
       x = 'CD3+ cells/kg', 
       y = 'Days survived post-transplant')

```

The plot illustrates the relationship between CD3+ dose (cells/kg) and patient survival post-transplant (days). Each black dot represents and individual patient, showing a wide range of survival times (0 to \>3000 days) across spectrum of CD3+ doses. A linear regression (blue line) with its 95% confidence interval (gray band) indicates a very slight negative trend, suggesting that higher CD3+ doses may be weakly associated with shorter survival. The confidence interval broadens at higher doses, reflecting greater uncertaity due to limited data. Overall, there is a substantial variability in survival regardless of CD3+ dose, indicating that CD3+ dose alone is a poor predictor of post-transplant survival. The observed negative association is minimal and likely lacks clinical significance.

The development of acute (aGvHD III/IV) and extensive chronic (cGvHD) graft- versus-host diseade has been associated with the dose of CD3+ T cells administered during bone marrow transplantation. Higher CD3+ doses can enhance the graft immune response but also increase the risk of severe GvHD. Therefore, CD3+ dose id critical factor influencing early and late post-transplant immunological outcomes, higlighting the need for a careful balance between benefit and risk

In this analysis, we explore the relationship between CD3+ T cell dose, patient survival time. and the development of graft-versus-host disease (GvHD) following bone marrow transplantation. Specifically, we examine how the ocurrence of severe acute GvHD (aGvHD III/IV) and extensive chronic GvHD (cGvHD) correlates with CD3+ cell dose and impacts post-transplant survival. Separate scatter plots are generated for each GvHD type to visualize potential trends and differences, providing insights into the immunological outcomes associated with varying CD3+ doses.

For aGvHDIIIIV:

```{r}
# Filter only the survival group 
group_surv <- function(data) {
  data |>
    filter(survival_status == '0')
}

ggplot(group_surv(df), 
       aes(x = CD3dkgx10d8, 
           y = survival_time, 
           color = aGvHDIIIIV)) + 
  geom_point(size = 3, alpha = 0.7) + 
  scale_color_gradient(low = 'blue', high = 'red') + 
  labs(
    x = 'Doses of CD3+', 
    y = 'Survival Time (days)',
    color = 'aGvHD III/IV'
  ) +
  theme_minimal() + 
  
  geom_smooth(aes(group = aGvHDIIIIV), method = 'lm', se = FALSE, linetype = 'dashed')
```

The analysis of post-transplant survival relative to administered CD3+ dose shows a slight negative trend, suggesting that higher CD3+ doses may be associated with reduced survival, potentially mediated by the development of severe aGvHD. Patients without severe aGvHD are distributed across the full range of CD3+ doses and exhibit highly variable survival times, indicating that the absence of severe aGvHD does not necessarily ensure longer survival. In contrast, patients who developed severe aGvHD tend to cluster at low intermediate CD3+ doses, with some showing shorter survival, consistent with the expected detrimental impact of severe aGvHD. However , the wide dispersion of data points highlights the influence of additional factors, such as patient age, underlying disease, or complications, on survival. Overall, while a weak inverse relationship between CD3+ dose and survival is observed, the patterns is not strictly linear.

for extcGvHD ( chronic) :

```{r}
# Filter only the survival group 
group_surv <- function(data) {
  data |>
    filter(survival_status == '0')
}

# Plot

ggplot(group_surv(df),
       aes(x = CD3dkgx10d8, 
           y = survival_time,
           color = extcGvHD)) + 
  geom_point(size = 3, alpha = 0.7) + 
  scale_color_gradient(low = 'orange', high = 'green') + 
  labs(
    x = 'Doses of CD3+', 
    y = 'Survival time (days)',
    color = 'cGvHD extense'
  )+
  theme_minimal() +
  geom_smooth(aes(group = extcGvHD), method = 'lm', se = FALSE, linetype = 'dashed')
```

# Analizar grafica

CMV virus

# Box plot for recipient CMV

```{r}
ggplot(data, aes(
  x = RecipientCMV, 
  y = survival_time, 
  fill = RecipientCMV)) + 
  geom_boxplot() + 
  geom_jitter(width = 0.2, alpha = 0.5) + 
  labs(
    title = 'Survival time by Recipient CMV status',
    x = 'Recipient CMV', 
    y = 'Survival time (days)' + 
  theme_minimal()
  )
```

## Bloxplot for DonorCMV

```{r}

ggplot(data, aes(x = DonorCMV, 
                 y = survival_time, 
                 fill = DonorCMV)) + 
  
  geom_jitter(with = 0.2, alpha = 0.5) + 
  labs(title = 'Survival time by Donor CMV status', 
       x = 'Donor CMV', 
       y = 'Survival time (days)') + 
    theme_minimal()
    
```

# Boxplot for CMVs status (compatibility)

```{r}
# Take out the 0, because dont give information about the compatibility 

data_new <- data |>
  filter(CMVstatus != 0)

ggplot(data_new, aes(
  x = CMVstatus, 
  y = survival_time,
  fill = CMVstatus)) + 

  geom_jitter(width = 0.2, alpha = 0.5) + 
  labs(title = 'Survival time by CMV compatibility', 
       x = 'CMV Compatibility', 
       y = 'Survival time (days)') +
  theme_minimal()
```

Tengo que ver que significa el 1, 2 y R en cuandot a la compatibililidad)

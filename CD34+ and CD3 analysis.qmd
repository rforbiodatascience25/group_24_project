---
title: "CD34+ and CD3 analysis"
author: "inma"
format: html
editor: visual
---

# 1. LOAD LIBRARIES

```{r}

library(tidyverse)
library(ggplot2)
library(dplyr)
```

# 2. LOAD DATA

```{r}
data_clean <- read_tsv('data/03_dat_aug.tsv.gz')
```

# 3. ANALYSIS

## 3.1. CD34+ ANALYSIS

**Description**:

```{r}

data <- data_clean |>
  filter(survival_status == 'Dead')

# Plot using the fuction 
ggplot(data, 
       aes(x = CD34kgx10d6, 
           y = survival_time)) + 
  geom_point() + 
  geom_smooth(method = 'lm', se = TRUE) + 
  labs(title = 'CD34+ dose vs Survival Days',
       x = 'CD34+ cells/kg', 
       y = 'Days survived post-transplant')

```

**Description** :

```{r}

data_clean |>
  group_by(survival_status) |>
  ggplot(aes(x = survival_status, 
             y = CD34kgx10d6, 
             fill = survival_status)) + 
  geom_boxplot(alpha = 0.5) +
  labs(title = "CD34+ dose for each Survival Status",
       x = "Survival Status",
       y = "CD34+ cells/kg") +
  scale_fill_viridis_d()
```

## 3.2. CD3 ANALYSIS

**Description**:

CD3+ case (without filtering)

```{r}

data <- data_clean |> 
  filter(survival_status == 'Dead')

ggplot(data, 
       aes(x = CD3dkgx10d8, 
           y = survival_time)) +
  geom_point() + 
  geom_smooth(method = 'lm', se = TRUE) + 
  labs(title = 'CD3 dose vs survival Days',
       x = 'CD3+ cells/kg', 
       y = 'Days survived post-transplant')



```

**Description** :

```{r}

ggplot(data_clean,
       aes(x = survival_status, 
           y = CD3dkgx10d8,
           fill = survival_status)) +
  geom_boxplot(alpha = 0.5) +
  labs(title = "CD3+ dose for each Survival Status",
       x = "Survival Status",
       y = "CD3+ cells/kg",
       fill = 'Survival Status') +
  theme_minimal() +
  scale_fill_viridis_d()

```

## 3.3. aGvHD III/IV and cGvHD extense ANALYSIS

The development of acute (aGvHD III/IV) and extensive chronic (cGvHD) graft- versus-host diseade has been associated with the dose of CD3+ T cells administered during bone marrow transplantation. Higher CD3+ doses can enhance the graft immune response but also increase the risk of severe GvHD. Therefore, CD3+ dose is critical factor influencing early and late post-transplant immunological outcomes, higlighting the need for a careful balance between benefit and risk

In this analysis, we explore the relationship between CD3+ T cell dose, patient survival time and the development of graft-versus-host disease (GvHD) following bone marrow transplantation. Specifically, we examine how the ocurrence of severe acute GvHD (aGvHD III/IV) and extensive chronic GvHD (cGvHD) correlates with CD3+ cell dose and impacts post-transplant survival. Separate scatter plots are generated for each GvHD type to visualize potential trends and differences, providing insights into the immunological outcomes associated with varying CD3+ doses.

### 3.3.1. aGvHD III/IV (acute Graft-vs-Host Disease)

**Description**:

The analysis of post-transplant survival relative to administered CD3+ dose shows a slight negative trend, suggesting that higher CD3+ doses may be associated with reduced survival, potentially mediated by the development of severe aGvHD. Patients without severe aGvHD are distributed across the full range of CD3+ doses and exhibit highly variable survival times, indicating that the absence of severe aGvHD does not necessarily ensure longer survival. In contrast, patients who developed severe aGvHD tend to cluster at low intermediate CD3+ doses, with some showing shorter survival, consistent with the expected detrimental impact of severe aGvHD. However , the wide dispersion of data points highlights the influence of additional factors, such as patient age, underlying disease, or complications, on survival. Overall, while a weak inverse relationship between CD3+ dose and survival is observed, the patterns is not strictly linear.

```{r}

ggplot(data_clean, 
       aes(x = CD3dkgx10d8, 
           y = survival_time, 
           color = aGvHDIIIIV)) + 
  geom_point(size = 3, alpha = 0.7) + 
  scale_fill_viridis_d() + 

  geom_smooth(aes(group = aGvHDIIIIV), 
              method = 'lm', 
              se = FALSE) +
  theme_minimal() 
```

**Description** :

This analysis examines the impact of infused CD3+ T-cell dose on post-transplant survival in patients with and without extensive chronic graft-versus-host disease (cGvHD). Higher CD3+ doses were associated with reduced survival in both groups, suggesting that excessive donor T-cell infusion may increase harmful immune-mediated toxicity. However, patients who developed extensive cGvHD showed slightly longer survival and a less pronounced decline in response to CD3+ dose, which could indicate a beneficial graft-versus-disease effect.

```{r}

# Filter only the survival group 
group_surv <- function(data_clean) {
  data_clean |>
    filter(survival_status == '0')
}

# Plot

ggplot(group_surv(data_clean),
       aes(x = CD3dkgx10d8, 
           y = survival_time,
           color = factor(extcGvHD))) + 
  geom_point(size = 3, alpha = 0.7) + 
  scale_color_brewer(palette = 'Set1') + 
  labs(
    x = 'Doses of CD3+', 
    y = 'Survival time (days)',
    color = 'cGvHD extense'
  )+
  theme_minimal() +
  geom_smooth(aes(group = extcGvHD), method = 'lm', se = FALSE, linetype = 'dashed')
```

```{r}

ggplot(data_clean, 
       aes(x = CD3dkgx10d8, 
           y = survival_time, 
           color = factor(aGvHDIIIIV))) + 
  geom_point(size = 3, alpha = 0.7) + 
  scale_color_brewer(palette = 'Set1') + 

  geom_smooth(aes(group = aGvHDIIIIV), method = 'lm', se = FALSE, linetype = 'dashed') +
  theme_minimal() 
```

## 4. CMV VIRUS

### 4.1 .Mixed plot between survival and non-survival groupsd:

```{r}

data_new <- data_clean |>
  filter(!is.na(CMVstatus), !is.na(survival_time))

ggplot(data_new, aes(
  x = as.factor(CMVstatus), 
  y = survival_time,
  fill = as.factor(CMVstatus))) + 
  geom_boxplot() +
  geom_jitter(width = 0.2, alpha = 0.5) +
  facet_wrap(~survival_status) +  # separate between survival and deceasedy pa
  labs(title = "Survival time by CMV compatibility and survival status",
       x = "CMV Compatibility",
       y = "Survival time (days)",
       fill = "CMVstatus") +
  theme_minimal()

```

### 4.2. For the survival group
